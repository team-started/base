.deploy-app:template:
  stage: deploy
  image: $CI_REGISTRY_IMAGE:deploy
  before_script:
    # Start ssh-agent and add the ssh private key to the agent
    - eval $(ssh-agent -s)
    - echo "$DEPLOYMENT_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null

    - mkdir -p ~/.ssh
    - ssh-keyscan -p ${DEPLOYMENT_PORT} ${DEPLOYMENT_HOST} >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploy ${CI_COMMIT_SHA} to server (${DEPLOYMENT_HOST})"
    - surf deploy App
  cache:
    key: ${CI_COMMIT_REF_SLUG}
